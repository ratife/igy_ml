# -*- coding: utf-8 -*-
"""Augmented.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1_LKYa_yICL-iMpL2Q4jGq4jbufltxkv7
"""

# Commented out IPython magic to ensure Python compatibility.
# import libraries
from IPython.display import Image, display
import numpy as np
import os
from os.path import join
from PIL import ImageFile
import pandas as pd
from matplotlib import cm
import seaborn as sns
from tensorflow.python.keras.models import Sequential
from tensorflow.python.keras.layers import Dense, Flatten, GlobalAveragePooling2D
from keras.applications.resnet50 import preprocess_input
from tensorflow.python.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.applications import ResNet50
from tensorflow.keras.preprocessing.image import load_img, img_to_array
from sklearn.metrics import mean_squared_error, mean_absolute_error, roc_auc_score, classification_report, confusion_matrix
import matplotlib.pyplot as plt
from sklearn.utils import shuffle
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
from sklearn.ensemble import IsolationForest
from sklearn import svm
from sklearn.mixture import GaussianMixture
from sklearn.isotonic import IsotonicRegression
import re
#from resizeimage import resizeimage
import pickle
ImageFile.LOAD_TRUNCATED_IMAGES = True
import glob
import cv2
plt.style.use('fivethirtyeight')
# %matplotlib inline

ls

pwd



!unzip /content/augmented_version.zip

ls







os.chdir('/content/augmented')

#data_directory = glob.glob("*")
#img = [cv2.imread(data_directory[i]) for i in range(len(data_directory))]
# import plaque image from data
train_img_dir = glob.glob("*")
#all_train_img_paths = [join(train_img_dir,filename) for filename in os.listdir(train_img_dir)] 
img = [cv2.imread(train_img_dir[i]) for i in range(len(train_img_dir))]

img = np.array(img)

train_data,test_data = train_test_split(img, test_size = 0.1,random_state=42)

len(train_img_dir)

def denoising(img_paths):
    dst_vide=[]
    #img_height, img_width = 224,224
    #img = [load_img(img_path, target_size=(img_height, img_width)) for img_path in img_paths]
    #img = [resizeimage.resize_crop(img[i], (224, 224)) for i in range(len(img_paths))]
    #img = np.array(imgs)
    ##img = [cv2.imread(img_paths[i]) for i in range(len(img_paths))]
    img = [cv2.resize(img_paths[i], (224,224)) for i in range(len(img_paths))]
    
    #rgb_vide=[]
    for x in img:
        b,g,r = cv2.split(x)           # get b,g,r
        sary = cv2.cvtColor(img[11], cv2.COLOR_BGR2RGB)
        rgb_img = cv2.merge([r,g,b])     # switch it to rgb
        #rgb_vide.append(rgb_img)

        # Denoising
        dst = cv2.fastNlMeansDenoisingColored(x,None,10,10,7,21)

        b,g,r = cv2.split(dst)           # get b,g,r
        rgb_dst = cv2.merge([r,g,b])     # switch it to rgb
        dst_vide.append(rgb_dst)
        img_data = np.array(dst_vide)
    return img_data

X_train = denoising(train_data)

#X_test = denoising(test_data)









# get features from resnet50 

##resnet_weights_path = 'resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5'

# X : images numpy array
resnet_model = ResNet50(input_shape=(224, 224, 3), weights='imagenet', include_top=False)  # Since top layer is the fc layer used for predictions

X_train = resnet_model.predict(X_train)

X_train.shape

X_train = X_train.reshape(X_train.shape[0],X_train.shape[1]*X_train.shape[2]*X_train.shape[3])

X_train.shape

# Train classifier and obtain predictions for OC-SVM
#oc_svm_clf = svm.OneClassSVM(gamma=0.001, kernel='rbf', nu=0.08)  # Obtained using grid search
if_clf = IsolationForest(contamination=0.08, max_features=1.0, max_samples=1.0, n_estimators=40)  # Obtained using grid search

#oc_svm_clf.fit(X_train1)
if_clf.fit(X_train)

# Further compute accuracy, precision and recall for the two predictions sets obtained

#Save pretrained model
import pickle
pkl_filename1 = "isol_plaque_or_not_denoising.pkl"
#pkl_filename2 = "oc_isol_plate_classification.pkl"
with open(pkl_filename1, 'wb') as file1:
    pickle.dump(if_clf, file1)
#with open(pkl_filename2, 'wb') as file2:
 #   pickle.dump(if_clf, file2)

from google.colab import files
files.download('isol_plaque_or_not_denoising.pkl')

# Train classifier and obtain predictions for OC-SVM
oc_svm_clf = svm.OneClassSVM(gamma=0.001, kernel='rbf', nu=0.08)  # Obtained using grid search
#if_clf = IsolationForest(contamination=0.08, max_features=1.0, max_samples=1.0, n_estimators=40)  # Obtained using grid search

oc_svm_clf.fit(X_train1)
#if_clf.fit(X_train1)

# Further compute accuracy, precision and recall for the two predictions sets obtained

#Save pretrained model
import pickle
#pkl_filename1 = "oc_svm_plaque_classification.pkl"
pkl_filename2 = "svm_sans_bruit_.pkl"
#with open(pkl_filename1, 'wb') as file1:
 #   pickle.dump(oc_svm_clf, file1)
with open(pkl_filename2, 'wb') as file2:
    pickle.dump(oc_svm_clf, file2)

from google.colab import files
files.download('oc_svm_plaque_classification.pkl')

from google.colab import files
files.download('oc_svm_plaque_classification.pkl')

