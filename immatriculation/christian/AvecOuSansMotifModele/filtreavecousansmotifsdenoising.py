# -*- coding: utf-8 -*-
"""FiltreAvecOuSansMotifsDenoising.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1kQyL-qmYQ_kEcbI42yMPKo4lwFnsLFbe
"""

# Commented out IPython magic to ensure Python compatibility.
# import libraries
from IPython.display import Image, display
import numpy as np
import os
from os.path import join
from PIL import ImageFile
import pandas as pd
from matplotlib import cm
import seaborn as sns
from tensorflow.python.keras.models import Sequential
from tensorflow.python.keras.layers import Dense, Flatten, GlobalAveragePooling2D
from keras.applications.resnet50 import preprocess_input
from tensorflow.python.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.applications import ResNet50
from tensorflow.keras.preprocessing.image import load_img, img_to_array
from sklearn.metrics import mean_squared_error, mean_absolute_error, roc_auc_score, classification_report, confusion_matrix
import matplotlib.pyplot as plt
from sklearn.utils import shuffle
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
from sklearn.ensemble import IsolationForest
from sklearn import svm
from sklearn.mixture import GaussianMixture
from sklearn.isotonic import IsotonicRegression
import re
#from resizeimage import resizeimage
import pickle
ImageFile.LOAD_TRUNCATED_IMAGES = True
import glob
import cv2
plt.style.use('fivethirtyeight')
# %matplotlib inline

!unzip /content/motifs_datasets.zip

ls

"""SansMotif"""

# import plaque image from data
train_img_dir = "motifs_datasets/sans_motif/"
all_train_img_paths = [join(train_img_dir,filename) for filename in os.listdir(train_img_dir)]

# split plaque data into train, test, and val
train_img_paths, test_img_paths_car = train_test_split(all_train_img_paths, test_size=0.25, random_state=42)
train_img_paths, val_img_paths_car = train_test_split(train_img_paths, test_size=0.25, random_state=42)



"""AvecMotif"""

#  import not plate image
natural_images_path = "motifs_datasets/"
test_img_paths_no_car = []
for d in [d for d in os.listdir("motifs_datasets/") if d!= "sans_motif"]:  
    test_img_dir_na = natural_images_path+d
    test_img_paths_no_car.append([join(test_img_dir_na,filename) for filename in os.listdir(test_img_dir_na)])
    
test_img_paths_no_car_flat = [item for sublist in test_img_paths_no_car for item in sublist]
test_img_paths_no_car, val_img_paths_no_car = train_test_split(test_img_paths_no_car_flat, test_size = 0.25, random_state = 42)

def natural_img_dir(image_path):
    path_regex = r"datasets\/(\w*)"
    if 'data' in image_path:
        return re.findall(path_regex,image_path,re.MULTILINE)[0].strip()
    else:
        return 'sans_motif'



# create test dataframe
all_test_paths = test_img_paths_car+test_img_paths_no_car
test_path_df = pd.DataFrame({
    'path': all_test_paths,
    'is_without_motif': [1 if path in test_img_paths_car else 0 for path in all_test_paths]
})
test_path_df = shuffle(test_path_df,random_state = 0).reset_index(drop = True)
test_path_df['image_type'] = test_path_df['path'].apply(lambda x: natural_img_dir(x))
all_test_paths = test_path_df['path'].tolist()

print('Distribution of Image Types in Test Set')
print(test_path_df['image_type'].value_counts())

"""BaseDeDonnéeDeValidation"""

# create val dataframe
all_val_paths = val_img_paths_car+val_img_paths_no_car
val_path_df = pd.DataFrame({
    'path': all_val_paths,
    'is_without_motif': [1 if path in val_img_paths_car else 0 for path in all_val_paths]
})
val_path_df = shuffle(val_path_df,random_state = 0).reset_index(drop = True)
val_path_df['image_type'] = val_path_df['path'].apply(lambda x: natural_img_dir(x))
all_val_paths = val_path_df['path'].tolist()

print('Distribution of Image Types in Validation Set')
print(val_path_df['image_type'].value_counts())



"""FEATURES EXTRACTION"""

#Use denoising to process image input

def denoising(img_paths):
    dst_vide=[]
    #img_height, img_width = 224,224
    #img = [load_img(img_path, target_size=(img_height, img_width)) for img_path in img_paths]
    #img = [resizeimage.resize_crop(img[i], (224, 224)) for i in range(len(img_paths))]
    #img = np.array(imgs)
    img = [cv2.imread(img_paths[i]) for i in range(len(img_paths))]
    img = [cv2.resize(img[i], (224,224)) for i in range(len(img_paths))]
    
    #rgb_vide=[]
    for x in img:
        b,g,r = cv2.split(x)           # get b,g,r
        sary = cv2.cvtColor(img[11], cv2.COLOR_BGR2RGB)
        rgb_img = cv2.merge([r,g,b])     # switch it to rgb
        #rgb_vide.append(rgb_img)

        # Denoising
        dst = cv2.fastNlMeansDenoisingColored(x,None,10,10,7,21)

        b,g,r = cv2.split(dst)           # get b,g,r
        rgb_dst = cv2.merge([r,g,b])     # switch it to rgb
        dst_vide.append(rgb_dst)
        img_data = np.array(dst_vide)
    return img_data

X_train = denoising(train_img_paths)

#X_test = denoising(all_test_paths)



# get features from resnet50 

image_size = 224
resnet_model = ResNet50(input_shape=(image_size, image_size, 3), weights='imagenet', include_top=False)  # Since top layer is the fc layer used for predictions

X_train1 = resnet_model.predict(X_train)
#X_test1 = resnet_model.predict(X_test)

X_train1.shape

X_train1 = X_train1.reshape(X_train1.shape[0],X_train1.shape[1]*X_train1.shape[2]*X_train1.shape[3])

X_train1.shape

# Train classifier and obtain predictions for OC-SVM
#oc_svm_clf = svm.OneClassSVM(gamma=0.001, kernel='rbf', nu=0.08)  # Obtained using grid search
if_clf = IsolationForest(contamination=0.08, max_features=1.0, max_samples=1.0, n_estimators=40)  # Obtained using grid search

#oc_svm_clf.fit(X_train1)
if_clf.fit(X_train1)

# Further compute accuracy, precision and recall for the two predictions sets obtained

#Save pretrained model
import pickle
#pkl_filename1 = "oc_svm_With_motif_sans_polling.pkl"
pkl_filename2 = "oc_isol_denoising_avec_ou_sans_motif_sans_pooling.pkl"
#with open(pkl_filename1, 'wb') as file1:
    #pickle.dump(oc_svm_clf, file1)
with open(pkl_filename2, 'wb') as file2:
    pickle.dump(if_clf, file2)

from google.colab import files
files.download('oc_isol_denoising_avec_ou_sans_motif_sans_pooling.pkl')

